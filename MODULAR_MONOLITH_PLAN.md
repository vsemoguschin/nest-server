## План перехода к модульному монолиту и подготовка к микросервисам

### 1. Инвентаризация и архитектурная фиксация
- **Каталог доменов:** описать текущие bounded context’ы (`deals`, `planfact`, `dashboards`, `commercial-datas`, `payments`, `clients`, `ad` и др.).
- **Контракты:** зафиксировать публичные DTO, сервисные методы, события; подготовить диаграммы зависимостей.
- **ADR:** завести журнал архитектурных решений, где документируются ключевые изменения и выбранные технологии.

### 2. Организация модульного монолита
- **Nest-модули:** для каждого домена — отдельный модуль с экспортируемым фасадом (`application` слой) и скрытым `core`.
- **Слои портов/адаптеров:** вынести работу с БД, внешними API, файлами (Prisma, Axios, YandexDisk) в `infrastructure`, оставить бизнес-правила чистыми.
- **Внутренний event bus:** добавить in-process события (например, Nest EventEmitter) для обмена между доменами без прямых зависимостей.
- **ESLint-ограничения:** настроить правила на запрет импорта внутренних частей чужих доменов (например, `import/no-restricted-paths`).

### 3. Повышение качества и тестовое покрытие
- **Unit/интеграционные тесты:** добавить тесты для критичных доменов (`deals`, `planfact`, `payments`), mock внешних интеграций.
- **Контрактные тесты:** закрепить соглашения между модулями, покрыть доменные события snapshot/contract тестами.
- **Pre-commit:** внедрить `husky`/`lint-staged` для запуска `eslint`, `prettier`, юнит-тестов перед коммитом.

### 4. CI/CD и сборка артефактов
- **Пайплайн:** на каждый PR запускать lint/test/build, на merge — собирать артефакт (Docker-образ) и выкладывать в registry.
- **Стейджинг:** настроить отдельное окружение для smoke-тестов перед продом.
- **Автоматизация деплоя:** использовать GitHub Actions/GitLab CI, задокументировать шаги отката.

### 5. Контейнеризация и инфраструктура
- **Dockerfile:** multi-stage сборка NestJS приложения (`npm ci` → build → минимальный runtime-слой).
- **Docker Compose:** локальная разработка с Postgres, Redis, брокером сообщений.
- **Инфраструктура как код:** Terraform/Ansible/Helm для серверов, БД, очередей; цель — воспроизводимые окружения.

### 6. Наблюдаемость и управление конфигурацией
- **Логи:** единый формат (JSON), correlation id во всех запросах.
- **Метрики и трассировка:** Prometheus + Grafana, OpenTelemetry + Jaeger/Tempo для распределённых трасс.
- **Алерты:** SLA/SLO по ключевым доменным метрикам (создание сделки, синхронизация PlanFact и т.д.).
- **Secret Management:** отказ от `.env` в гите, использование Vault/AWS Secrets Manager/Doppler.

### 7. Доменные события и подготовка к микросервисам
- **Каталог событий:** описать и документировать события (`deal.created`, `deal.updated`, `planfact.sync.completed` и др.).
- **Outbox-паттерн:** добавить таблицы/процесс для гарантированной публикации событий.
- **Прототип брокера:** выбрать Kafka/RabbitMQ/NATS, настроить локально, протестировать публикацию и потребление.

### 8. API Gateway и BFF
- **Единый вход:** спроектировать API Gateway/BFF, который агрегирует данные и скрывает внутренние модули.
- **JWT/ACL:** централизовать аутентификацию, авторизацию, rate limit, версионирование API.
- **Стратегия миграции:** по мере готовности переносить фронтенд-запросы через Gateway, а не напрямую в доменные контроллеры.

### 9. Организация команд и процессов
- **Ответственность:** закрепить домены за командами (end-to-end ответственность: код, тесты, деплой, мониторинг).
- **Ревью:** формализовать чек-лист code review (соответствие правилам модульного монолита, наличие тестов, обновлений ADR).
- **Онбординг:** обновить README с инструкциями запуска, описанием доменов, ссылками на документацию.

### 10. Пошаговый вынос в микросервисы (по необходимости)
- **Критерии выноса:** нагрузка, независимость релизов, разные требования к масштабированию/хранилищам.
- **PoC:** выбрать один кандидат (например, `deals-read`), вынести в отдельный сервис, протестировать коммуникацию через брокер.
- **Общий каркас:** переиспользовать Nest boilerplate (логи, метрики, health-check), стандартизовать Docker/CI.

---

## Прописные правила модульного монолита
- **Границы непроницаемы:** чужие доменные сущности не импортируются напрямую — только через фасады и события.
- **Чистые слои:** доменные правила не зависят от Nest, Prisma и инфраструктуры.
- **Контракты документируются и версионируются:** любое изменение DTO/события — через ADR и тесты.
- **Общение через фасады и события:** прямых SQL-запросов к чужим таблицам быть не должно.
- **Наблюдаемость обязательна:** логи, метрики, trace id — стандарт, а не опция.
- **Инфраструктура воспроизводима:** все окружения описаны кодом, деплой автоматизирован.
- **Безопасность и секреты:** токены и ключи — только через менеджеры секретов, регулярная ротация.
- **Тесты — барьер на вход:** коммит без тестов/линтов не проходит, PR без тестового покрытия не merge’ится.
- **Документация актуальна:** изменения в архитектуре сопровождаются обновлением схем и описаний.
- **Эволюция итеративна:** любые крупные изменения вносятся небольшими шагами с обратной совместимостью.

