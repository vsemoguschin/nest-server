# Repository Guidelines (Nest)

## Структура проекта и модули
- `src/`: исходники NestJS.
- `src/domains/*`: доменные модули (контроллеры/сервисы/DTO).
- `src/prisma/*`: `PrismaModule`/`PrismaService` и доступ к БД.
- `src/common/*`: guards, filters, interceptors, decorators, ошибки.
- `src/auth/*`, `src/profile/*`, `src/admin/*`: прикладные модули доступа.
- `src/integrations/*`: внешние интеграции.
- `test/`: e2e и тестовая инфраструктура.
- `prisma/`: схема и миграционная точка входа.
- `docs/`: регламенты, навигация, быстрый поиск.

## Порядок чтения инструкций (обязательно)
1. `AGENTS.md` (этот файл): обязательные проектные правила.
2. `docs/NEST_AGENT_PLAYBOOK.md`: детальный workflow и чек-листы.
3. `docs/PROJECT_NAVIGATION.md`: карта проекта.
4. `docs/SEARCH_RECIPES.md`: быстрый поиск по коду.
5. `docs/INSTRUCTION_LIFECYCLE.md`: как обновлять инструкции по ходу разработки.

## Сборка, тесты и разработка
- `npm run start:dev`: локальная разработка с watch.
- `npm run build`: сборка в `dist/`.
- `npm run lint`: ESLint.
- `npm run format`: Prettier.
- `npm test`: unit-тесты.
- `npm run test:e2e`: e2e.
- `npm run test:cov`: покрытие.
- `npm run prisma:deploy`: `prisma db push && prisma generate`.

## Обязательный workflow агента
1. Определить затронутый домен (`src/domains/*`, `auth`, `profile`, `prisma`, `common`).
2. Перед изменениями API библиотек свериться с актуальной документацией через MCP Context7.
3. Для Prisma-сущностей сначала свериться со `schema.prisma`.
4. Переиспользовать существующие сервисы/DTO/утилиты до создания новых.
5. Сделать минимальный дифф без побочных рефакторингов.
6. Прогнать релевантные проверки (lint/test/build — по типу задачи).
7. В отчете указать: изменения, риски, проверки, измененные файлы.
8. После завершения задачи с фактическими изменениями добавлять запись о выполненной задаче в `/crm/AGENT_TASK.md` (только `- [x]`, простой язык).

## Prisma как справочник терминов (обязательно)
- Перед работой с моделями, полями, DTO и API по доменным сущностям сначала читать `prisma/schema.prisma`.
- Использовать комментарии в схеме как источник русских обозначений моделей и полей.
- При выборе имен и маппинге полей ориентироваться на схему Prisma как на первичный источник истины.
- Если в задаче и в схеме есть расхождения по названиям, сначала сверяться со схемой и явно отмечать расхождение в ответе.

## NestJS + Prisma best practices
- Разделять ответственность: `controller` (transport), `service` (business), Prisma-слой (data access).
- Валидировать входы через DTO + `class-validator`; не принимать «сырые» `any` payload.
- Бизнес-правила не размещать в контроллерах.
- Для связанных изменений в БД использовать транзакции Prisma.
- Единообразно обрабатывать ошибки (HTTP exceptions / фильтры), без утечек внутренних деталей.
- Избегать N+1 запросов и лишних выборок; выбирать только нужные поля.

## MCP/Context7 для Nest и Prisma (обязательно)
- Для сигнатур/паттернов NestJS и Prisma не полагаться на память.
- Перед внедрением спорного API-паттерна сначала проверять документацию через MCP Context7.
- Если версия важна, сначала сверяться с `package.json`, затем запрашивать документацию.

## Переиспользование и антидублирование (обязательно)
- Перед созданием нового сервиса/DTO/утилиты искать существующие реализации в `src/domains/*`, `src/common/*`, `src/services/*`.
- Если реализация «почти подходит», приоритет: обобщить/апгрейдить её под новый кейс.
- Апгрейд должен быть оправдан: не усложнять API и не вводить лишние абстракции.
- Приоритет: просто-понятно-минималистично (KISS/YAGNI).
- Запрещены дубли вида `*New*`, `*V2*`, `*Copy*` без явной причины и согласования.

## Definition of Done
- Изменения соответствуют архитектуре Nest-модулей.
- Сущности и поля согласованы с `prisma/schema.prisma`.
- Релевантные проверки выполнены успешно.
- Решение не перегружено преждевременной универсальностью.
- Документация обновлена, если появилось новое правило/паттерн.

## Детальный регламент и навигация
- Детальный playbook: `docs/NEST_AGENT_PLAYBOOK.md`.
- Карта проекта: `docs/PROJECT_NAVIGATION.md`.
- Рецепты поиска: `docs/SEARCH_RECIPES.md`.
- Эволюция инструкций: `docs/INSTRUCTION_LIFECYCLE.md`.
