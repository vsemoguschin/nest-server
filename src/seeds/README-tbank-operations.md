# Скрипт для получения операций из Т-Банка

## Описание

Скрипт `seed-tbank-operations.ts` получает банковские операции из API Т-Банка и сохраняет их в таблицу `OriginalOperationFromTbank`.

## Использование

### Базовое использование (сегодняшний день)

```bash
npx ts-node src/seeds/seed-tbank-operations.ts
```

### Просмотр статуса синхронизации

```bash
npx ts-node src/seeds/seed-tbank-operations.ts --status
```

### С указанием дат

```bash
# Получить операции за конкретный день
npx ts-node src/seeds/seed-tbank-operations.ts 2024-01-15 2024-01-15

# Получить операции за период
npx ts-node src/seeds/seed-tbank-operations.ts 2024-10-01 2024-01-31

# С указанием лимита операций
npx ts-node src/seeds/seed-tbank-operations.ts 2025-10-01 2024-01-31 5000

# С фильтром по категориям операций
npx ts-node src/seeds/seed-tbank-operations.ts 2024-01-01 2024-01-31 1000 "income,expense"

# С фильтром по ИНН контрагентов
npx ts-node src/seeds/seed-tbank-operations.ts 2024-01-01 2024-01-31 1000 "" "1234567890,0987654321"
```

## Параметры

1. `from` (необязательный) - дата начала в формате YYYY-MM-DD (по умолчанию: сегодня)
2. `to` (необязательный) - дата окончания в формате YYYY-MM-DD (по умолчанию: сегодня)
3. `limit` (необязательный) - максимальное количество операций (по умолчанию: 1000)
4. `categories` (необязательный) - категории операций через запятую (например: "income,expense")
5. `inns` (необязательный) - ИНН контрагентов через запятую (например: "1234567890,0987654321")

## Переменные окружения

Убедитесь, что установлена переменная:

- `TB_TOKEN` - токен для доступа к API Т-Банка

## Что делает скрипт

1. Получает все аккаунты с `isReal: true` из таблицы `PlanFactAccount`
2. Для каждого аккаунта делает запрос к API Т-Банка с поддержкой пагинации
3. Автоматически обрабатывает `nextCursor` для получения всех операций
4. Соблюдает ограничения API (максимум 20 запросов в секунду)
5. Сохраняет полученные операции в таблицу `OriginalOperationFromTbank`
6. Использует `upsert` для избежания дублирования операций
7. Поддерживает фильтрацию по категориям операций и ИНН контрагентов
8. **Отслеживает статус синхронизации** в таблице `TbankSyncStatus`
9. **Записывает крайнюю дату обновления** операций для каждого аккаунта

## Структура данных

Скрипт сохраняет следующие поля из API:

- `operationId` - уникальный ID операции
- `operationDate` - дата операции
- `typeOfOperation` - тип операции
- `category` - категория операции
- `description` - описание
- `payPurpose` - назначение платежа
- `accountAmount` - сумма
- Данные контрагента (счет, ИНН, КПП, БИК, банк, название)
- Категория расходов (если есть)

## Модели базы данных

### OriginalOperationFromTbank

Хранит оригинальные операции из API Т-Банка со всеми полями.

### TbankSyncStatus

Отслеживает статус синхронизации для каждого аккаунта:

- `lastSyncDate` - дата последней синхронизации
- `lastOperationDate` - дата последней полученной операции
- `totalOperations` - общее количество синхронизированных операций
- `syncStatus` - статус (success, error, in_progress)
- `errorMessage` - сообщение об ошибке (если есть)

## Миграция базы данных

После добавления новых моделей выполните:

```bash
npx prisma migrate dev --name add-tbank-models
```
