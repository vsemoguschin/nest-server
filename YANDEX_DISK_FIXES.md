# Исправления обработки ошибок Яндекс.Диска

## Примененные исправления

### 1. ✅ Добавлена обработка SSL ошибок

SSL ошибки теперь обрабатываются как retriable (повторяемые) ошибки:
- `SELF_SIGNED_CERT_IN_CHAIN`
- `UNABLE_TO_VERIFY_LEAF_SIGNATURE`
- `CERT_HAS_EXPIRED`

Эти ошибки теперь будут автоматически повторяться до 3 раз с exponential backoff.

### 2. ✅ Сохранение оригинальной ошибки

Оригинальная ошибка и код ошибки теперь сохраняются в `HttpException`, что позволяет:
- Правильно определять коды ошибок в `TaskFilesService`
- Видеть реальные коды ошибок в логах (вместо `code=unknown`)
- Корректно обрабатывать retry логику

### 3. ✅ Улучшено извлечение кода ошибки

В `TaskFilesService` теперь проверяются:
- Прямой `axios.isAxiosError`
- Оригинальная ошибка из `HttpException`
- Код ошибки из `HttpException`

### 4. ✅ Настройка SSL проверки

Добавлена возможность управления проверкой SSL сертификатов через переменную окружения:

```bash
# По умолчанию проверка включена (рекомендуется)
YANDEX_DISK_REJECT_UNAUTHORIZED=true

# Для временного решения проблемы SSL (небезопасно!)
YANDEX_DISK_REJECT_UNAUTHORIZED=false
```

⚠️ **ВНИМАНИЕ**: Отключение проверки SSL снижает безопасность! Используйте только как временное решение.

### 5. ✅ Улучшено логирование ошибки 409

Ошибка 409 (CONFLICT) при создании папок теперь логируется на уровне DEBUG вместо ERROR, так как это нормальная ситуация (папка уже существует).

## Использование

### Для решения проблемы SSL ошибок

**Вариант 1: Обновить сертификаты (рекомендуется)**

```bash
# На сервере
apt-get update
apt-get install ca-certificates
update-ca-certificates
```

**Вариант 2: Временно отключить проверку SSL**

Добавьте в `.env`:
```bash
YANDEX_DISK_REJECT_UNAUTHORIZED=false
```

Затем перезапустите приложение:
```bash
pm2 restart nestjs-app
```

### Включение детального логирования

Для диагностики проблем добавьте в `.env`:
```bash
YANDEX_DISK_DETAILED_LOGGING=true
```

## Результаты

После применения исправлений:

1. ✅ SSL ошибки будут автоматически повторяться
2. ✅ Коды ошибок будут правильно определяться в логах
3. ✅ Ошибки будут корректно обрабатываться в retry логике
4. ✅ Улучшены сообщения об ошибках для диагностики
5. ✅ Меньше ложных ERROR логов для нормальных ситуаций (409)

## Мониторинг

После применения исправлений проверьте логи:

```bash
# Проверить, что SSL ошибки обрабатываются
pm2 logs nestjs-app | grep "SELF_SIGNED_CERT_IN_CHAIN"

# Проверить retry попытки
pm2 logs nestjs-app | grep "Upload attempt"

# Проверить успешные загрузки
pm2 logs nestjs-app | grep "upload complete"
```

## Переменные окружения

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `YANDEX_DISK_REJECT_UNAUTHORIZED` | Проверка SSL сертификатов | `true` |
| `YANDEX_DISK_DETAILED_LOGGING` | Детальное логирование запросов | `false` |
| `YANDEX_DISK_UPLOAD_TIMEOUT` | Таймаут загрузки (мс) | `1800000` (30 мин) |

